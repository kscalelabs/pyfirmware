#!/usr/bin/env bash

set -euo pipefail

# verify active environment is 'firmware'
env_name="${CONDA_DEFAULT_ENV:-${MAMBA_DEFAULT_ENV:-$(basename "${VIRTUAL_ENV:-}")}}"
if [ "${env_name}" != "firmware" ]; then
    echo "Error: active environment must be 'firmware' (current: '${env_name:-none}')"
    exit 1
fi

policy=""

# Parse positional args
policy="${1:-}"

if [ -z "$policy" ]; then
    echo "Usage: kbot-run <path-to-policy.kinfer>"
    exit 1
fi

# ---------------------------
# Bring up CAN and set torques
# ---------------------------
_set_can_and_max_torques.sh

# ---------------------------
# Run firmware policy loop
# ---------------------------
echo "Running firmware with policy: $policy"
PY="$(command -v python)"
sudo -E chrt 30 "$PY" -m firmware.main "$policy"
