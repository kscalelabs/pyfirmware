#!/usr/bin/env bash

set -euo pipefail

# ---------------------------
# Policy directory handling
# ---------------------------
policy_dir="${POLICY_DIR:-${HOME}/.policies}"
remote_policies="mu:~/public_policies/"

mkdir -p "$policy_dir"
echo "Syncing policies from $remote_policies to $policy_dir (with deletion)..."
rsync -aLP --delete "$remote_policies" "$policy_dir/"

# ---------------------------
# Bring up CAN and set torques
# ---------------------------
_set_can_and_max_torques.sh

# ---------------------------
# Run firmware policy loop
# ---------------------------
echo "=============================================="
echo "               Running firmware               "
echo "=============================================="
PY="$(command -v python)"
sudo -E chrt 30 "$PY" -m firmware.main "$policy_dir"
