#!/usr/bin/env bash

set -euo pipefail

# ---------------------------
# Policy directory handling
# ---------------------------

if [ -z "${POLICY_DIR:-}" ]; then
    echo "Error: POLICY_DIR environment variable is required"
    echo "Example: POLICY_DIR=/path/to/policies kbot-run"
    exit 1
fi

# ---------------------------
# Bring up CAN and set torques
# ---------------------------
_set_can_and_max_torques.sh

# ---------------------------
# Run firmware policy loop
# ---------------------------
echo "=============================================="
echo "               Running firmware               "
echo "=============================================="
PY="$(command -v python)"
sudo -E chrt 30 "$PY" -m firmware.main "$POLICY_DIR"
